"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _wtcControllerElement=_interopRequireWildcard(require("wtc-controller-element")),_wtcControllerViewports=_interopRequireDefault(require("wtc-controller-viewports"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):{};desc.get||desc.set?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,newObj}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _possibleConstructorReturn(self,call){return!call||"object"!==_typeof(call)&&"function"!=typeof call?_assertThisInitialized(self):call}function _getPrototypeOf(o){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o})(o,p)}var defaults={fullWidth:!1,vpOn:0,startAt:null,loopFrom:null,loopTo:null},AutoplayVideo=function(_Viewport){function AutoplayVideo(element,options){var _this;return _classCallCheck(this,AutoplayVideo),(_this=_possibleConstructorReturn(this,_getPrototypeOf(AutoplayVideo).call(this,element))).hasStarted=!1,_this.initiated=!1,_this.onLoopCheck=_this.onLoopCheck.bind(_assertThisInitialized(_this)),_this.init=_this.init.bind(_assertThisInitialized(_this)),_this.onEnded=_this.onEnded.bind(_assertThisInitialized(_this)),_this.onFrozen=_this.onFrozen.bind(_assertThisInitialized(_this)),_this.animationCallback=_this.viewportAnimationCallback.bind(_assertThisInitialized(_this)),options=Object.assign({},defaults,options),_this.options={fullWidth:_this.element.classList.contains("autoplay-video--fullscreen")||options.fullWidth,vpOn:_this.element.hasAttribute("data-vp-on")?parseInt(_this.element.getAttribute("data-vp-on")):options.vpOn,startAt:_this.element.hasAttribute("data-autoplay-video--start-at")?parseFloat(_this.element.getAttribute("data-autoplay-video--start-at")):options.startAt,loopFrom:_this.element.hasAttribute("data-autoplay-video--loop-from")?parseFloat(_this.element.getAttribute("data-autoplay-video--loop-from")):options.loopFrom,loopTo:_this.element.hasAttribute("data-autoplay-video--loop-to")?parseFloat(_this.element.getAttribute("data-autoplay-video--loop-to")):options.loopTo},_this.options.fullWidth&&!_this.element.classList.contains("autoplay-video--fullscreen")&&_this.element.classList.add("autoplay-video--fullscreen"),_this._video=_this.element.querySelector(".autoplay-video__video"),_this._fallback=_this.element.querySelector(".autoplay-video__fallback"),_this._video.muted=!0,_this._video.setAttribute("playsinline",""),_this._video.setAttribute("muted",""),isNaN(_this.options.startAt)||null==_this.options.startAt||(_this._video.currentTime=_this.options.startAt),navigator&&navigator.connection?navigator.connection.saveData?_this.onFrozen(_assertThisInitialized(_this)):2<=_this._video.readyState?_this.init():_this._video.addEventListener("canplay",_this.init,!1):(_this._video.readyState,_this.init()),_this.options.loopTo&&(_this._video.loop=!1,_this.options.loopFrom?_this.loopPeriod=!0:_this._video.addEventListener("ended",_this.onEnded,!0)),_this._video.addEventListener("error",_this.onFrozen,!0),_this}return _inherits(AutoplayVideo,_wtcControllerViewports["default"]),_createClass(AutoplayVideo,[{key:"init",value:function(){var _this2=this;if(!this.initiated){if(this.initiated=!0,this.ratio=this._video.videoWidth/this._video.videoHeight,this.options.fullWidth){var resizeTimer=null,resizeDebounce=function(){clearTimeout(resizeTimer),resizeTimer=setTimeout(function(){_this2.videoResize()},300)};resizeDebounce(),window.addEventListener("resize",resizeDebounce)}this.isOnScreen&&this.playVideo()}}},{key:"videoResize",value:function(){var targetW=this._video.parentNode.offsetWidth,targetH=this._video.parentNode.offsetHeight,newW=0,newH=0;targetW/targetH>this.ratio?newH=(newW=targetW)*this.ratio:newW=(newH=targetH)*this.ratio,this._video.style.height=newH+"px",this._video.style.width=newW+"px"}},{key:"onPlay",value:function(){this.element.classList.add("is-playing"),(this.hasStarted=!0)!==this.videoPlaying&&!0===this.loopPeriod&&(this.videoPlaying=!0,requestAnimationFrame(this.onLoopCheck))}},{key:"onFrozen",value:function(){this.element.classList.add("is-frozen"),this.videoPlaying=!1}},{key:"onPause",value:function(){this.element.classList.add("is-paused"),this.hasStarted=!1,this.videoPlaying=!1}},{key:"onEnded",value:function(){this._video.currentTime=this.options.loopTo,this._video.play()}},{key:"onLoopCheck",value:function(delta){!0===this.videoPlaying&&!0===this.loopPeriod&&requestAnimationFrame(this.onLoopCheck),this._video.currentTime>=this.options.loopFrom&&(this._video.currentTime=this.options.loopTo)}},{key:"pauseVideo",value:function(){this._video.pause(),this.onPause()}},{key:"playVideo",value:function(){if(2<=this._video.readyState)if(this._video.paused){var testPlay=this._video.play();try{"undefined"!=typeof Promise&&-1!==Promise.toString().indexOf("[native code]")&&testPlay&&testPlay instanceof Promise?testPlay.then(this.onPlay.bind(this),this.onFrozen.bind(this)):this._video.paused?this.onFrozen():this.onPlay()}catch(error){this.onFrozen()}}else this.onPlay();else setTimeout(this.playVideo.bind(this),500)}},{key:"viewportAnimationCallback",value:function(topPercent){this.isOnScreen||!this.hasStarted||this._video.paused?topPercent>this.options.vpOn&&this.initiated&&!this.hasStarted&&this._video.paused&&this.playVideo():(this.pauseVideo(),isNaN(this.options.startAt)||null==this.options.startAt||(this._video.currentTime=this.options.startAt))}},{key:"video",get:function(){return this._video}}]),AutoplayVideo}();_wtcControllerElement.ExecuteControllers.registerController(AutoplayVideo,"AutoplayVideo");var _default=AutoplayVideo;exports.default=_default;