"use strict";function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _wtcControllerElement=_interopRequireWildcard(require("wtc-controller-element")),_wtcControllerViewports=_interopRequireDefault(require("wtc-controller-viewports"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var cache=new WeakMap;return _getRequireWildcardCache=function(){return cache},cache}function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache();if(cache&&cache.has(obj))return cache.get(obj);var key,desc,newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&((desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null)&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]);return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o})(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function(){var NewTarget,Super=_getPrototypeOf(Derived);return _possibleConstructorReturn(this,hasNativeReflectConstruct?(NewTarget=_getPrototypeOf(this).constructor,Reflect.construct(Super,arguments,NewTarget)):Super.apply(this,arguments))}}function _possibleConstructorReturn(self,call){return!call||"object"!==_typeof(call)&&"function"!=typeof call?_assertThisInitialized(self):call}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(o){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}var defaults={vpOn:0,startAt:null,loopFrom:null,loopTo:null},AutoplayVideo=function(){_inherits(AutoplayVideo,_wtcControllerViewports["default"]);var _super=_createSuper(AutoplayVideo);function AutoplayVideo(_this,options){return _classCallCheck(this,AutoplayVideo),(_this=_super.call(this,_this)).onLoopCheck=_this.onLoopCheck.bind(_assertThisInitialized(_this)),_this.init=_this.init.bind(_assertThisInitialized(_this)),_this.onEnded=_this.onEnded.bind(_assertThisInitialized(_this)),_this.onFrozen=_this.onFrozen.bind(_assertThisInitialized(_this)),_this.animationCallback=_this.viewportAnimationCallback.bind(_assertThisInitialized(_this)),options=Object.assign({},defaults,options),_this.options={vpOn:_this.element.hasAttribute("data-vp-on")?parseInt(_this.element.getAttribute("data-vp-on")):options.vpOn,startAt:_this.element.hasAttribute("data-autoplay-video--start-at")?parseFloat(_this.element.getAttribute("data-autoplay-video--start-at")):options.startAt,loopFrom:_this.element.hasAttribute("data-autoplay-video--loop-from")?parseFloat(_this.element.getAttribute("data-autoplay-video--loop-from")):options.loopFrom,loopTo:_this.element.hasAttribute("data-autoplay-video--loop-to")?parseFloat(_this.element.getAttribute("data-autoplay-video--loop-to")):options.loopTo},_this.video=_this.element.querySelector(".autoplay-video__video"),_this.fallback=_this.element.querySelector(".autoplay-video__fallback"),_this.video.muted=!0,_this.video.setAttribute("playsinline",""),_this.video.setAttribute("muted",""),isNaN(_this.startAt)||null==_this.startAt||(_this.video.currentTime=_this.startAt),navigator&&navigator.connection?navigator.connection.saveData?_this.onFrozen(_assertThisInitialized(_this)):2<=_this.video.readyState?_this.init():_this.video.addEventListener("canplay",_this.init,!1):(_this.video.readyState,_this.init()),_this.loopTo&&(_this.video.loop=!1,_this.loopFrom?_this.loopPeriod=!0:_this.video.addEventListener("ended",_this.onEnded,!0)),_this.video.addEventListener("error",_this.onFrozen,!0),_this}return _createClass(AutoplayVideo,[{key:"init",value:function(){this.initiated||(this.initiated=!0,this.ratio=this.video.videoWidth/this.video.videoHeight,this.isOnScreen&&this.playVideo())}},{key:"videoResize",value:function(){var targetW=this.video.parentNode.offsetWidth,targetH=this.video.parentNode.offsetHeight,newW=0,newH=0;targetW/targetH>this.ratio?newH=(newW=targetW)*this.ratio:newW=(newH=targetH)*this.ratio,this.video.style.height=newH+"px",this.video.style.width=newW+"px"}},{key:"onPlay",value:function(){this.element.classList.add("is-playing"),(this.hasStarted=!0)!==this.videoPlaying&&!0===this.loopPeriod&&(this.videoPlaying=!0,requestAnimationFrame(this.onLoopCheck))}},{key:"onFrozen",value:function(){this.element.classList.add("is-frozen"),this.videoPlaying=!1}},{key:"onPause",value:function(){this.element.classList.add("is-paused"),this.hasStarted=!1,this.videoPlaying=!1}},{key:"onEnded",value:function(){this.video.currentTime=this.loopTo,this.video.play()}},{key:"onLoopCheck",value:function(delta){!0===this.videoPlaying&&!0===this.loopPeriod&&requestAnimationFrame(this.onLoopCheck),this.video.currentTime>=this.loopFrom&&(this.video.currentTime=this.loopTo)}},{key:"pauseVideo",value:function(){this.video.pause(),this.onPause()}},{key:"playVideo",value:function(){if(2<=this.video.readyState)if(this.video.paused){var testPlay=this.video.play();try{"undefined"!=typeof Promise&&-1!==Promise.toString().indexOf("[native code]")&&testPlay&&testPlay instanceof Promise?testPlay.then(this.onPlay.bind(this),this.onFrozen.bind(this)):this.video.paused?this.onFrozen():this.onPlay()}catch(error){this.onFrozen()}}else this.onPlay();else setTimeout(this.playVideo.bind(this),500)}},{key:"viewportAnimationCallback",value:function(topPercent){this.isOnScreen||!this.hasStarted||this.video.paused?topPercent>this.options.vpOn&&this.initiated&&!this.hasStarted&&this.video.paused&&this.playVideo():(this.pauseVideo(),isNaN(this.startAt)||null==this.startAt||(this.video.currentTime=this.startAt))}},{key:"video",set:function(value){value instanceof HTMLElement&&(this._video=value)},get:function(){return this._video||null}},{key:"fallback",set:function(value){value instanceof HTMLElement&&(this._fallback=value)},get:function(){return this._fallback||null}},{key:"hasStarted",set:function(value){this._hasStarted=!0===value},get:function(){return this._hasStarted||!1}},{key:"initiated",set:function(value){this._initiated=!0===value},get:function(){return this._initiated||!1}},{key:"loopPeriod",set:function(value){this._loopPeriod=!0===value},get:function(){return this._loopPeriod||!1}},{key:"videoPlaying",set:function(value){this._videoPlaying=!0===value},get:function(){return this._videoPlaying||!1}},{key:"ratio",set:function(value){isNaN(value)||(this._ratio=value)},get:function(){return this._ratio||null}},{key:"startAt",get:function(){return this.options.startAt||null}},{key:"loopFrom",get:function(){return this.options.loopFrom||null}},{key:"loopTo",get:function(){return this.options.loopTo||null}}]),AutoplayVideo}();_wtcControllerElement.ExecuteControllers.registerController(AutoplayVideo,"AutoplayVideo");var _default=AutoplayVideo;exports.default=AutoplayVideo;